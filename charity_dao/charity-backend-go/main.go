package main

import (
	"context"
	"crypto/ecdsa"
	"fmt"
	"log"

	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
)

func main() {
	//1. Kết nối tới mạng Hardhat Local
	client, err := ethclient.Dial("http://127.0.0.1:8545")
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println("Kết nối thành công tới Hardhat node")

	//2. Lấy địa chỉ ví của người dùng
	privateKey, err := crypto.HexToECDSA("YOUR_PRIVATE_KEY_HERE")
	if err != nil {
		log.Fatal(err)

	}

	publicKey := privateKey.Public()
	publicKeyECDSA, ok := publicKey.(*ecdsa.PublicKey)
	if !ok {
		log.Fatal("không thể chuyển đổi public key sang ECDSA")
	}

	fromAddress := crypto.PubkeyToAddress(*publicKeyECDSA)
	nonce, err := client.PendingNonceAt(context.Background(), fromAddress)
	if err != nil {
		log.Fatal(err)
	}

	gasPrice, err := client.SuggestGasPrice(context.Background())
	if err != nil {
		log.Fatal(err)
	}

	chainID := big.NewInt(31337)
	auth, err := bind.NewKeyedTransactorWithChainID(privateKey, chainID)
	if err != nil {
		log.Fatal(err)
	}
	auth.Nonce = big.NewInt(int64(nonce))
	auth.Value = big.NewInt(1e18) // 1 ETH
	auth.GasLimit = uint64(3000000)
	auth.GasPrice = gasPrice

	//3. Địa chỉ contract Charity
	contractAddress := common.HexToAddress("0x6080604052600436106100585760003560e01c8062b37044146100c05780632e1a7d4d146100eb5780638da5cb5b14610114578063cc6cb19a1461013f578063dc5b2ee41461017c578063ed88c68e146101b9576100bb565b366100bb573073ffffffffffffffffffffffffffffffffffffffff1663ed88c68e6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156100a557600080fd5b505af11580156100b9573d6000803e3d6000fd5b005b600080fd5b3480156100cc57600080fd5b506100d56101c3565b6040516100e29190610579565b60405180910390f35b3480156100f757600080fd5b50610112600480360381019061010d91906105c5565b6101c9565b005b34801561012057600080fd5b506101296103d9565b6040516101369190610633565b60405180910390f35b34801561014b57600080fd5b506101666004803603810190610161919061067a565b6103fd565b6040516101739190610579565b60405180910390f35b34801561018857600080fd5b506101a3600480360381019061019e919061067a565b610415565b6040516101b09190610579565b60405180910390f35b6101c161045e565b005b60015481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610257576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161024e90610704565b60405180910390fd5b4781111561029a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029190610770565b60405180910390fd5b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16826040516102e1906107c1565b60006040518083038185875af1925050503d806000811461031e576040519150601f19603f3d011682016040523d82523d6000602084013e610323565b606091505b5050905080610367576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161035e90610822565b60405180910390fd5b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364836040516103cd9190610579565b60405180910390a25050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60026020528060005260406000206000915090505481565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600034116104a1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104989061088e565b60405180910390fd5b34600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546104f091906108dd565b92505081905550346001600082825461050991906108dd565b925050819055503373ffffffffffffffffffffffffffffffffffffffff167f2a01595cddf097c90216094025db714da3f4e5bd8877b56ba86a24ecead8e543346040516105569190610579565b60405180910390a2565b6000819050919050565b61057381610560565b82525050565b600060208201905061058e600083018461056a565b92915050565b600080fd5b6105a281610560565b81146105ad57600080fd5b50565b6000813590506105bf81610599565b92915050565b6000602082840312156105db576105da610594565b5b60006105e9848285016105b0565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061061d826105f2565b9050919050565b61062d81610612565b82525050565b60006020820190506106486000830184610624565b92915050565b61065781610612565b811461066257600080fd5b50565b6000813590506106748161064e565b92915050565b6000602082840312156106905761068f610594565b5b600061069e84828501610665565b91505092915050565b600082825260208201905092915050565b7f4e6f74206f776e65720000000000000000000000000000000000000000000000600082015250565b60006106ee6009836106a7565b91506106f9826106b8565b602082019050919050565b6000602082019050818103600083015261071d816106e1565b9050919050565b7f496e73756666696369656e742062616c616e6365000000000000000000000000600082015250565b600061075a6014836106a7565b915061076582610724565b602082019050919050565b600060208201905081810360008301526107898161074d565b9050919050565b600081905092915050565b50565b60006107ab600083610790565b91506107b68261079b565b600082019050919050565b60006107cc8261079e565b9150819050919050565b7f5769746864726177206661696c65640000000000000000000000000000000000600082015250565b600061080c600f836106a7565b9150610817826107d6565b602082019050919050565b6000602082019050818103600083015261083b816107ff565b9050919050565b7f4d7573742073656e642045544800000000000000000000000000000000000000600082015250565b6000610878600d836106a7565b915061088382610842565b602082019050919050565b600060208201905081810360008301526108a78161086b565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006108e882610560565b91506108f383610560565b925082820190508082111561090b5761090a6108ae565b5b9291505056fea26469706673582212205ef522f7b967c61e3c92be82e120f7fdfd4aeea9d91b1a16fea0543605e1e61864736f6c634300081c0033")
	vault, err := charity.NewCharity(contractAddress, client)
	ìf err != nil {
		log.Fatal(err)
	}

	//4. Gọi hàm donate
	tx, err := vault.Donate(auth)
	if err != nil{
		log.Fatal(err)
	}

	fmt.Printf("Giao dịch đã được gửi: %s\n", tx.Hash().Hex())
}